# =============================================================================
# Phase 1 Project Configuration
# WSI-based Skin Cancer Classification (COBRA Dataset)
# =============================================================================

# Project info
project:
  name: "phase1_wsi_classification"
  description: "Whole Slide Image classification for BCC skin cancer detection"
  version: "1.0.0"

# Paths
paths:
  data_root: "data"
  raw_wsi_dir: "data/raw_wsi"
  tiles_dir: "data/tiles"
  manifests_dir: "data/manifests"
  logs_dir: "logs"
  checkpoints_dir: "logs/checkpoints"
  
# Dataset configuration
dataset:
  name: "cobra"
  source: "s3://cobra-pathology/packages/bcc/"
  # Subset configuration for demo/development
  subset:
    enabled: true
    train_per_class: 400
    val_per_class: 100
    test_per_class: 100
  # Label mapping: 0=benign (non-BCC), 1=malignant (BCC)
  labels:
    0: "benign"
    1: "malignant"
  classes: ["benign", "malignant"]
  num_classes: 2

# Tile extraction configuration
tile_extraction:
  tile_size: 512            # Output tile size in pixels
  target_mpp: 0.5           # Target microns per pixel (~20x magnification)
  max_tiles_per_slide: 500  # Maximum tiles to extract per slide
  min_tissue_fraction: 0.3  # Minimum tissue content in tile
  blur_threshold: 80.0      # Laplacian variance threshold for blur detection
  jpeg_quality: 90
  seed: 42

# Model configuration
model:
  architecture: "resnet18"
  pretrained: true
  num_classes: 2
  dropout: 0.5

# Training configuration
training:
  batch_size: 32
  num_workers: 4
  learning_rate: 0.0001
  weight_decay: 0.0001
  epochs: 20
  early_stopping_patience: 5
  scheduler:
    name: "cosine"
    T_max: 20
    eta_min: 0.000001
  
# Image transforms
transforms:
  train:
    resize: 224
    random_horizontal_flip: true
    random_vertical_flip: true
    random_rotation: 15
    color_jitter:
      brightness: 0.2
      contrast: 0.2
      saturation: 0.2
      hue: 0.1
    normalize:
      mean: [0.485, 0.456, 0.406]
      std: [0.229, 0.224, 0.225]
  eval:
    resize: 224
    normalize:
      mean: [0.485, 0.456, 0.406]
      std: [0.229, 0.224, 0.225]

# Slide inference / aggregation
inference:
  batch_size: 64
  # Aggregation parameters
  aggregation:
    method: "percentile"  # Options: mean, max, percentile, topk
    top_k: 50             # Number of top tiles to consider
    percentile: 90        # Percentile for score calculation
    threshold: 0.5        # Decision threshold for malignant
    # Alternative: score + ratio based decision
    use_ratio_rule: true
    ratio_threshold: 0.15 # Min fraction of high-prob tiles
    tile_prob_threshold: 0.7  # Threshold for "high probability" tile

# Evaluation
evaluation:
  metrics: ["accuracy", "balanced_accuracy", "precision", "recall", "specificity", "f1", "auc"]
  save_predictions: true
  generate_confusion_matrix: true

# Logging
logging:
  level: "INFO"
  save_logs: true
  tensorboard: true

# Random seeds for reproducibility
seed: 42
